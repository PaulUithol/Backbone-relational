{"version":3,"file":"backbone-relational.js","sources":["../src/utils/semaphore.js","../src/utils/underscore-compat.js","../src/utils/blocking-queue.js","../src/event-queue.js","../src/config.js","../src/utils/extend.js","../src/utils/object.js","../src/utils/relation-type-store.js","../src/relation-type-store.js","../src/utils/store.js","../src/store.js","../src/relation.js","../src/model.js","../src/collection.js","../src/relation.has-one.js","../src/relation.has-many.js","../src/backbone-relational.js"],"sourcesContent":["/**\n * Semaphore mixin; can be used as both binary and counting.\n **/\nexport default {\n\t_permitsAvailable: null,\n\t_permitsUsed: 0,\n\n\tacquire() {\n\t\tif (this._permitsAvailable && this._permitsUsed >= this._permitsAvailable) {\n\t\t\tthrow new Error('Max permits acquired');\n\t\t} else {\n\t\t\tthis._permitsUsed++;\n\t\t}\n\t},\n\n\trelease() {\n\t\tif (this._permitsUsed === 0) {\n\t\t\tthrow new Error('All permits released');\n\t\t} else {\n\t\t\tthis._permitsUsed--;\n\t\t}\n\t},\n\n\tisLocked() {\n\t\treturn this._permitsUsed > 0;\n\t},\n\n\tsetAvailablePermits(amount) {\n\t\tif (this._permitsUsed > amount) {\n\t\t\tthrow new Error('Available permits cannot be less than used permits');\n\t\t}\n\t\tthis._permitsAvailable = amount;\n\t}\n};\n","import _ from 'underscore';\n\n/**\n * Partial Underscore emulation when _ is Lodash.\n * Please try to write code that is compatible with both, but add\n * compatibility code below otherwise.\n */\nif (!_.any) {  // We have Lodash, make it imitate Underscore a bit more.\n\t_.any = _.some;\n\t_.all = _.every;\n\t_.contains = _.includes;\n\t_.pluck = _.map;\n}\n\nexport default _;\n","import _ from './underscore-compat';\nimport Semaphore from './semaphore';\n\n/**\n * A BlockingQueue that accumulates items while blocked (via 'block'),\n * and processes them when unblocked (via 'unblock').\n * Process can also be called manually (via 'process').\n */\nfunction BlockingQueue() {\n\tthis._queue = [];\n};\n\n_.extend(BlockingQueue.prototype, Semaphore, {\n\t_queue: null,\n\n\tadd(func) {\n\t\tif (this.isBlocked()) {\n\t\t\tthis._queue.push(func);\n\t\t} else {\n\t\t\tfunc();\n\t\t}\n\t},\n\n\t// Some of the queued events may trigger other blocking events. By\n\t// copying the queue here it allows queued events to process closer to\n\t// the natural order.\n\t//\n\t// queue events [ 'A', 'B', 'C' ]\n\t// A handler of 'B' triggers 'D' and 'E'\n\t// By copying `this._queue` this executes:\n\t// [ 'A', 'B', 'D', 'E', 'C' ]\n\t// The same order the would have executed if they didn't have to be\n\t// delayed and queued.\n\tprocess() {\n\t\tlet queue = this._queue;\n\t\tthis._queue = [];\n\t\twhile (queue && queue.length) {\n\t\t\tqueue.shift()();\n\t\t}\n\t},\n\n\tblock() {\n\t\tthis.acquire();\n\t},\n\n\tunblock() {\n\t\tthis.release();\n\t\tif (!this.isBlocked()) {\n\t\t\tthis.process();\n\t\t}\n\t},\n\n\tisBlocked() {\n\t\treturn this.isLocked();\n\t}\n});\n\nexport default BlockingQueue;\n","import BlockingQueue from './utils/blocking-queue';\n\n/**\n * Global event queue. Accumulates external events ('add:<key>', 'remove:<key>' and 'change:<key>')\n * until the top-level object is fully initialized (see 'Backbone.Relational.Model').\n */\nexport default new BlockingQueue();\n","export default {\n\tshowWarnings: true\n};\n","import { Model } from 'backbone';\n\nexport default Model.extend;\n","import _ from './underscore-compat';\nimport extend from './extend';\nimport Events from './events';\n\n/**\n * Base object to extend off of. Works similar to how you extend in Backbone\n */\nfunction ExtendableObject(...args) {\n\tthis.initialize.call(this, ...args);\n};\n_.extend(ExtendableObject.prototype, Events);\nExtendableObject.extend = extend;\n\nexport default ExtendableObject;\n","import BObject from './object';\n\nexport default BObject.extend({\n\tinitialize() {\n\t\tthis.types = {};\n\t},\n\tregisterType(name, Type) {\n\t\tthis.types[ name ] = Type;\n\t},\n\tunregisterType(name, Type) {\n\t\tif (name in this.types) {\n\t\t\tdelete this.types[ name ];\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t},\n\tfind(name) {\n\t\treturn this.types[ name ];\n\t}\n});\n","import RelationTypeStore from './utils/relation-type-store';\n\nexport default new RelationTypeStore();\n","import _ from './underscore-compat';\nimport { Model as BBModel } from 'backbone';\nimport BObject from './object';\nimport relationTypeStore from '../relation-type-store';\nimport config from '../config';\nimport Collection from '../collection';\n\n/**\n * Backbone.Store keeps track of all created (and destruction of) Backbone.Relational.Model.\n * Handles lookup for relations.\n */\nexport default BObject.extend({\n\tinitialize() {\n\t\tthis._collections = [];\n\t\tthis._reverseRelations = [];\n\t\tthis._orphanRelations = [];\n\t\tthis._subModels = [];\n\t\tthis._modelScopes = [window];\n\t},\n\n\t/**\n\t * Create a new `Relation`.\n\t * @param {Backbone.Relational.Model} [model]\n\t * @param {Object} relation\n\t * @param {Object} [options]\n\t */\n\tinitializeRelation(model, relation, options) {\n\t\tlet { type: Type } = relation;\n\t\tif (_.isString(Type)) {\n\t\t\tType = relationTypeStore.find(Type) || this.getObjectByName(Type);\n\t\t}\n\n\t\tif (_.isObject(Type)) {\n\t\t\tlet relationType = new Type(model, relation, options); // Also pushes the new Relation into `model._relations`\n\t\t} else if (config.showWarnings && console) {\n\t\t\tconsole.warn('Relation=%o; missing or invalid relation type!', relation);\n\t\t}\n\t},\n\n\t/**\n\t * Add a scope for `getObjectByName` to look for model types by name.\n\t * @param {Object} scope\n\t */\n\taddModelScope(scope) {\n\t\tthis._modelScopes.push(scope);\n\t},\n\n\t/**\n\t * Remove a scope.\n\t * @param {Object} scope\n\t */\n\tremoveModelScope(scope) {\n\t\tthis._modelScopes = _.without(this._modelScopes, scope);\n\t},\n\n\t/**\n\t * Add a set of subModelTypes to the store, that can be used to resolve the '_superModel'\n\t * for a model later in 'setupSuperModel'.\n\t *\n\t * @param {Backbone.Relational.Model} subModelTypes\n\t * @param {Backbone.Relational.Model} superModelType\n\t */\n\taddSubModels(subModelTypes, superModelType) {\n\t\tthis._subModels.push({\n\t\t\tsuperModelType,\n\t\t\tsubModels: subModelTypes\n\t\t});\n\t},\n\n\t/**\n\t * Check if the given modelType is registered as another model's subModel. If so, add it to the super model's\n\t * '_subModels', and set the modelType's '_superModel', '_subModelTypeName', and '_subModelTypeAttribute'.\n\t *\n\t * @param {Backbone.Relational.Model} modelType\n\t */\n\tsetupSuperModel(modelType) {\n\t\t_.find(this._subModels, (subModelDef) => {\n\t\t\treturn _.filter(subModelDef.subModels || [], (subModelTypeName, typeValue) => {\n\t\t\t\tlet subModelType = this.getObjectByName(subModelTypeName);\n\n\t\t\t\tif (modelType === subModelType) {\n\t\t\t\t\t// Set 'modelType' as a child of the found superModel\n\t\t\t\t\tsubModelDef.superModelType._subModels[ typeValue ] = modelType;\n\n\t\t\t\t\t// Set '_superModel', '_subModelTypeValue', and '_subModelTypeAttribute' on 'modelType'.\n\t\t\t\t\tmodelType._superModel = subModelDef.superModelType;\n\t\t\t\t\tmodelType._subModelTypeValue = typeValue;\n\t\t\t\t\tmodelType._subModelTypeAttribute = subModelDef.superModelType.prototype.subModelTypeAttribute;\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t}).length;\n\t\t});\n\t},\n\n\t/**\n\t * Add a reverse relation. Is added to the 'relations' property on model's prototype, and to\n\t * existing instances of 'model' in the store as well.\n\t * @param {Object} relation\n\t * @param {Backbone.Relational.Model} relation.model\n\t * @param {String} relation.type\n\t * @param {String} relation.key\n\t * @param {String|Object} relation.relatedModel\n\t */\n\taddReverseRelation(relation) {\n\t\tlet exists = _.any(this._reverseRelations, function(rel) {\n\t\t\treturn _.all(relation || [], function(val, key) {\n\t\t\t\treturn val === rel[ key ];\n\t\t\t});\n\t\t});\n\n\t\tif (!exists && relation.model && relation.type) {\n\t\t\tthis._reverseRelations.push(relation);\n\t\t\tthis._addRelation(relation.model, relation);\n\t\t\tthis.retroFitRelation(relation);\n\t\t}\n\t},\n\n\t/**\n\t * Deposit a `relation` for which the `relatedModel` can't be resolved at the moment.\n\t *\n\t * @param {Object} relation\n\t */\n\taddOrphanRelation(relation) {\n\t\tlet exists = _.any(this._orphanRelations, function(rel) {\n\t\t\treturn _.all(relation || [], function(val, key) {\n\t\t\t\treturn val === rel[ key ];\n\t\t\t});\n\t\t});\n\n\t\tif (!exists && relation.model && relation.type) {\n\t\t\tthis._orphanRelations.push(relation);\n\t\t}\n\t},\n\n\t/**\n\t * Try to initialize any `_orphanRelation`s\n\t */\n\tprocessOrphanRelations() {\n\t\t// Make sure to operate on a copy since we're removing while iterating\n\t\t_.each(this._orphanRelations.slice(0), (rel) => {\n\t\t\tlet relatedModel = this.getObjectByName(rel.relatedModel);\n\t\t\tif (relatedModel) {\n\t\t\t\tthis.initializeRelation(null, rel);\n\t\t\t\tthis._orphanRelations = _.without(this._orphanRelations, rel);\n\t\t\t}\n\t\t});\n\t},\n\n\t/**\n\t *\n\t * @param {Backbone.Relational.Model.constructor} type\n\t * @param {Object} relation\n\t * @private\n\t */\n\t_addRelation(type, relation) {\n\t\tif (!type.prototype.relations) {\n\t\t\ttype.prototype.relations = [];\n\t\t}\n\t\ttype.prototype.relations.push(relation);\n\n\t\t_.each(type._subModels || [], (subModel) => {\n\t\t\tthis._addRelation(subModel, relation);\n\t\t});\n\t},\n\n\t/**\n\t * Add a 'relation' to all existing instances of 'relation.model' in the store\n\t * @param {Object} relation\n\t */\n\tretroFitRelation(relation) {\n\t\tlet { type: RelationType } = relation;\n\n\t\tlet coll = this.getCollection(relation.model, false);\n\t\tcoll && coll.each(_.bind(function(model) {\n\t\t\tif (!(model instanceof relation.model)) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tlet relationType = new RelationType(model, relation);\n\t\t}, this));\n\t},\n\n\t/**\n\t * Find the Store's collection for a certain type of model.\n\t * @param {Backbone.Relational.Model} type\n\t * @param {Boolean} [create=true] Should a collection be created if none is found?\n\t * @return {Backbone.Relational.Collection} A collection if found (or applicable for 'model'), or null\n\t */\n\tgetCollection(type, create) {\n\t\tif (type instanceof BBModel) {\n\t\t\ttype = type.constructor;\n\t\t}\n\n\t\tlet rootModel = type;\n\t\twhile (rootModel._superModel) {\n\t\t\trootModel = rootModel._superModel;\n\t\t}\n\n\t\tlet coll = _.find(this._collections, function(item) {\n\t\t\treturn item.model === rootModel;\n\t\t});\n\n\t\tif (!coll && create !== false) {\n\t\t\tcoll = this._createCollection(rootModel);\n\t\t}\n\n\t\treturn coll;\n\t},\n\n\t/**\n\t * Find a model type on one of the modelScopes by name. Names are split on dots.\n\t * @param {String} name\n\t * @return {Object}\n\t */\n\tgetObjectByName(name) {\n\t\tlet parts = name.split('.');\n\t\tlet type = null;\n\n\t\t_.find(this._modelScopes, _.bind(function(scope) {\n\t\t\ttype = _.reduce(parts || [], function(memo, val) {\n\t\t\t\treturn memo ? memo[ val ] : undefined;\n\t\t\t}, scope);\n\n\t\t\tif (type && type !== scope) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}, this));\n\n\t\treturn type;\n\t},\n\n\t_createCollection(type) {\n\t\t// If 'type' is an instance, take its constructor\n\t\tif (!_.isObject(type)) {\n\t\t\ttype = type.constructor;\n\t\t}\n\n\t\t// Type should inherit from Backbone.Relational.Model.\n\t\t// if ( type.prototype instanceof Backbone.Relational.Model ) {\n\t\tlet coll = new Collection();\n\t\tcoll.model = type;\n\n\t\tthis._collections.push(coll);\n\t\t// }\n\n\t\treturn coll;\n\t},\n\n\t/**\n\t * Find the attribute that is to be used as the `id` on a given object\n\t * @param type\n\t * @param {String|Number|Object|Backbone.Relational.Model} item\n\t * @return {String|Number}\n\t */\n\tresolveIdForItem(type, item = null) {\n\t\tif (item === null) {\n\t\t\treturn null;\n\t\t}\n\n\t\tif (_.isString(item) || _.isNumber(item)) {\n\t\t\treturn item;\n\t\t}\n\n\t\treturn item.id || item[ type.prototype.idAttribute ] || null;\n\t},\n\n\t/**\n\t * Find a specific model of a certain `type` in the store\n\t * @param type\n\t * @param {String|Number|Object|Backbone.Relational.Model} item\n\t */\n\tfind(type, item) {\n\t\tlet id = this.resolveIdForItem(type, item);\n\t\tlet coll = this.getCollection(type);\n\n\t\t// Because the found object could be of any of the type's superModel\n\t\t// types, only return it if it's actually of the type asked for.\n\t\tif (coll) {\n\t\t\tlet obj = coll.get(id);\n\n\t\t\tif (obj instanceof type) {\n\t\t\t\treturn obj;\n\t\t\t}\n\t\t}\n\n\t\treturn null;\n\t},\n\n\t/**\n\t * Add a 'model' to its appropriate collection. Retain the original contents of 'model.collection'.\n\t * @param {Backbone.Relational.Model} model\n\t */\n\tregister(model) {\n\t\tlet coll = this.getCollection(model);\n\n\t\tif (coll) {\n\t\t\tlet modelColl = model.collection;\n\t\t\tcoll.add(model);\n\t\t\tmodel.collection = modelColl;\n\t\t}\n\t},\n\n\t/**\n\t * Check if the given model may use the given `id`\n\t * @param model\n\t * @param [id]\n\t */\n\tcheckId(model, id) {\n\t\tlet coll = this.getCollection(model);\n\t\tlet duplicate = coll && coll.get(id);\n\n\t\tif (duplicate && model !== duplicate) {\n\t\t\tif (config.showWarnings && console) {\n\t\t\t\tconsole.warn('Duplicate id! Old RelationalModel=%o, new RelationalModel=%o', duplicate, model);\n\t\t\t}\n\n\t\t\tthrow new Error('Cannot instantiate more than one Backbone.Relational.Model with the same id per type!');\n\t\t}\n\t},\n\n\t/**\n\t * Explicitly update a model's id in its store collection\n\t * @param {Backbone.Relational.Model} model\n\t */\n\tupdate(model) {\n\t\tlet coll = this.getCollection(model);\n\n\t\t// Register a model if it isn't yet (which happens if it was created without an id).\n\t\tif (!coll.contains(model)) {\n\t\t\tthis.register(model);\n\t\t}\n\n\t\t// This triggers updating the lookup indices kept in a collection\n\t\tcoll._onModelEvent('change:' + model.idAttribute, model, coll);\n\n\t\t// Trigger an event on model so related models (having the model's new id in their keyContents) can add it.\n\t\tmodel.trigger('relational:change:id', model, coll);\n\t},\n\n\t/**\n\t * Unregister from the store: a specific model, a collection, or a model type.\n\t * @param {Backbone.Relational.Model|Backbone.Relational.Model.constructor|Backbone.Relational.Collection} type\n\t */\n\tunregister(type) {\n\t\tlet coll;\n\t\tlet models = _.clone(type.models);\n\t\tif (type.model) {\n\t\t\tcoll = this.getCollection(type.model);\n\t\t} else {\n\t\t\tcoll = this.getCollection(type);\n\t\t\tmodels = _.clone(coll.models);\n\t\t}\n\n\t\tif (type instanceof BBModel) {\n\t\t\tmodels = [type];\n\t\t}\n\n\t\t_.each(models, (model) => {\n\t\t\tthis.stopListening(model);\n\t\t\t_.invoke(model.getRelations(), 'stopListening');\n\t\t});\n\n\t\t// If we've unregistered an entire store collection, reset the collection (which is much faster).\n\t\t// Otherwise, remove each model one by one.\n\t\tif (_.contains(this._collections, type)) {\n\t\t\tcoll.reset([]);\n\t\t} else {\n\t\t\t_.each(models, (model) => {\n\t\t\t\tif (coll.get(model)) {\n\t\t\t\t\tcoll.remove(model);\n\t\t\t\t} else {\n\t\t\t\t\tcoll.trigger('relational:remove', model, coll);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\n\t/**\n\t * Reset the `store` to it's original state. The `reverseRelations` are kept though, since attempting to\n\t * re-initialize these on models would lead to a large amount of warnings.\n\t */\n\treset() {\n\t\tthis.stopListening();\n\n\t\t// Unregister each collection to remove event listeners\n\t\t_.each(this._collections, (coll) => {\n\t\t\tthis.unregister(coll);\n\t\t});\n\n\t\tthis._collections = [];\n\t\tthis._subModels = [];\n\t\tthis._modelScopes = [window];\n\t}\n});\n","import Store from './utils/store';\n\nexport default new Store();\n","import _ from './utils/underscore-compat';\nimport Semaphore from './utils/semaphore';\nimport BObject from './utils/object';\nimport relationTypeStore from './relation-type-store';\nimport store from './store';\nimport config from './config';\nimport Model from './model';\n\n/**\n * The main Relation class, from which 'HasOne' and 'HasMany' inherit. Internally, 'relational:<key>' events\n * are used to regulate addition and removal of models from relations.\n *\n * @param {Backbone.Relational.Model} [instance] Model that this relation is created for. If no model is supplied,\n *      Relation just tries to instantiate it's `reverseRelation` if specified, and bails out after that.\n * @param {Object} options\n * @param {string} options.key\n * @param {Backbone.Relational.Model.constructor} options.relatedModel\n * @param {Boolean|String} [options.includeInJSON=true] Serialize the given attribute for related model(s)' in toJSON, or just their ids.\n * @param {Boolean} [options.createModels=true] Create objects from the contents of keys if the object is not found in Backbone.store.\n * @param {Object} [options.reverseRelation] Specify a bi-directional relation. If provided, Relation will reciprocate\n *    the relation to the 'relatedModel'. Required and optional properties match 'options', except that it also needs\n *    {Backbone.Relation|String} type ('HasOne' or 'HasMany').\n * @param {Object} opts\n */\nexport default BObject.extend(Semaphore).extend({\n\tinstance: null,\n\tkey: null,\n\tkeyContents: null,\n\trelatedModel: null,\n\trelatedCollection: null,\n\treverseRelation: null,\n\trelated: null,\n\n\tconstructor(instance, options, opts) {\n\t\tthis.instance = instance;\n\t\t// Make sure 'options' is sane, and fill with defaults from subclasses and this object's prototype\n\t\toptions = _.isObject(options) ? options : {};\n\t\tthis.reverseRelation = _.defaults(options.reverseRelation || {}, this.options.reverseRelation);\n\t\tthis.options = _.defaults(options, this.options, {\n\t\t\tcreateModels: true,\n\t\t\tincludeInJSON: true,\n\t\t\tisAutoRelation: false,\n\t\t\tautoFetch: false,\n\t\t\tparse: false\n\t\t});\n\n\t\t// TODO: handle this logic else where. it's crazy to have a parent depend on its children!!\n\t\tif (_.isString(this.reverseRelation.type)) {\n\t\t\tthis.reverseRelation.type = relationTypeStore.find(this.reverseRelation.type) || store.getObjectByName(this.reverseRelation.type);\n\t\t}\n\n\t\tthis.key = this.options.key;\n\t\tthis.keySource = this.options.keySource || this.key;\n\t\tthis.keyDestination = this.options.keyDestination || this.keySource || this.key;\n\n\t\tthis.model = this.options.model || this.instance.constructor;\n\n\t\tthis.relatedModel = this.options.relatedModel;\n\n\t\tif (_.isUndefined(this.relatedModel)) {\n\t\t\tthis.relatedModel = this.model;\n\t\t}\n\n\t\tif (_.isFunction(this.relatedModel) && !(this.relatedModel.prototype instanceof Model)) {\n\t\t\tthis.relatedModel = _.result(this, 'relatedModel');\n\t\t}\n\t\tif (_.isString(this.relatedModel)) {\n\t\t\tthis.relatedModel = store.getObjectByName(this.relatedModel);\n\t\t}\n\n\t\tif (!this.checkPreconditions()) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Add the reverse relation on 'relatedModel' to the store's reverseRelations\n\t\tif (!this.options.isAutoRelation && this.reverseRelation.type && this.reverseRelation.key) {\n\t\t\tstore.addReverseRelation(_.defaults({\n\t\t\t\tisAutoRelation: true,\n\t\t\t\tmodel: this.relatedModel,\n\t\t\t\trelatedModel: this.model,\n\t\t\t\treverseRelation: this.options // current relation is the 'reverseRelation' for its own reverseRelation\n\t\t\t},\n\t\t\t\tthis.reverseRelation // Take further properties from this.reverseRelation (type, key, etc.)\n\t\t\t));\n\t\t}\n\n\t\tif (instance) {\n\t\t\tlet contentKey = this.keySource;\n\t\t\tif (contentKey !== this.key && _.isObject(this.instance.get(this.key))) {\n\t\t\t\tcontentKey = this.key;\n\t\t\t}\n\n\t\t\tthis.setKeyContents(this.instance.get(contentKey));\n\t\t\tthis.relatedCollection = store.getCollection(this.relatedModel);\n\n\t\t\t// Explicitly clear 'keySource', to prevent a leaky abstraction if 'keySource' differs from 'key'.\n\t\t\tif (this.keySource !== this.key) {\n\t\t\t\tdelete this.instance.attributes[ this.keySource ];\n\t\t\t}\n\n\t\t\t// Add this Relation to instance._relations\n\t\t\tthis.instance._relations[ this.key ] = this;\n\n\t\t\tthis.initialize(opts);\n\n\t\t\tif (this.options.autoFetch) {\n\t\t\t\tthis.instance.getAsync(this.key, _.isObject(this.options.autoFetch) ? this.options.autoFetch : {});\n\t\t\t}\n\n\t\t\t// When 'relatedModel' are created or destroyed, check if it affects this relation.\n\t\t\tthis.listenTo(this.instance, 'destroy', this.destroy)\n\t\t\t\t.listenTo(this.relatedCollection, 'relational:add relational:change:id', this.tryAddRelated)\n\t\t\t\t.listenTo(this.relatedCollection, 'relational:remove', this.removeRelated);\n\t\t}\n\t},\n\n\t/**\n\t * Check several pre-conditions.\n\t * @return {Boolean} True if pre-conditions are satisfied, false if they're not.\n\t */\n\tcheckPreconditions() {\n\t\tlet i = this.instance;\n\t\tlet k = this.key;\n\t\tlet m = this.model;\n\t\tlet rm = this.relatedModel;\n\t\tlet warn = config.showWarnings && typeof console !== 'undefined';\n\n\t\tif (!m || !k || !rm) {\n\t\t\twarn && console.warn('Relation=%o: missing model, key or relatedModel (%o, %o, %o).', this, m, k, rm);\n\t\t\treturn false;\n\t\t}\n\t\t// Check if the type in 'model' inherits from Backbone.Relational.Model\n\t\tif (!(m.prototype instanceof Model)) {\n\t\t\twarn && console.warn('Relation=%o: model does not inherit from Backbone.Relational.Model (%o).', this, i);\n\t\t\treturn false;\n\t\t}\n\t\t// Check if the type in 'relatedModel' inherits from Backbone.Relational.Model\n\t\tif (!(rm.prototype instanceof Model)) {\n\t\t\twarn && console.warn('Relation=%o: relatedModel does not inherit from Backbone.Relational.Model (%o).', this, rm);\n\t\t\treturn false;\n\t\t}\n\t\t// Check if this is not a HasMany, and the reverse relation is HasMany as well\n\t\t// TODO: handle this logic elsewhere!\n\t\tif (this instanceof relationTypeStore.find('HasMany') && this.reverseRelation.type === relationTypeStore.find('HasMany')) {\n\t\t\twarn && console.warn('Relation=%o: relation is a HasMany, and the reverseRelation is HasMany as well.', this);\n\t\t\treturn false;\n\t\t}\n\t\t// Check if we're not attempting to create a relationship on a `key` that's already used.\n\t\tif (i && _.keys(i._relations).length) {\n\t\t\tlet existing = _.find(i._relations, _.bind(function(rel) {\n\t\t\t\treturn rel.key === k;\n\t\t\t}, this));\n\n\t\t\tif (existing) {\n\t\t\t\twarn && console.warn('Cannot create relation=%o on %o for model=%o: already taken by relation=%o.',\n\t\t\t\t\tthis, k, i, existing);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\treturn true;\n\t},\n\n\t/**\n\t * Set the related model(s) for this relation\n\t * @param {Backbone.Model|Backbone.Relational.Collection} related\n\t */\n\tsetRelated(related) {\n\t\tthis.related = related;\n\t\tthis.instance.attributes[ this.key ] = related;\n\t},\n\n\t/**\n\t * Determine if a relation (on a different RelationalModel) is the reverse\n\t * relation of the current one.\n\t * @param {Backbone.Relation} relation\n\t * @return {Boolean}\n\t */\n\t_isReverseRelation(relation) {\n\t\treturn relation.instance instanceof this.relatedModel && this.reverseRelation.key === relation.key &&\n\t\t\tthis.key === relation.reverseRelation.key;\n\t},\n\n\t/**\n\t * Get the reverse relations (pointing back to 'this.key' on 'this.instance') for the currently related model(s).\n\t * @param {Backbone.Relational.Model} [model] Get the reverse relations for a specific model.\n\t *    If not specified, 'this.related' is used.\n\t * @return {Backbone.Relation[]}\n\t */\n\tgetReverseRelations(model) {\n\t\tlet reverseRelations = [];\n\t\t// Iterate over 'model', 'this.related.models' (if this.related is a Backbone.Relational.Collection), or wrap 'this.related' in an array.\n\t\tlet models = !_.isUndefined(model) ? [model] : this.related && (this.related.models || [this.related]);\n\t\tlet relations = null;\n\t\tlet relation = null;\n\n\t\tfor (let i = 0; i < (models || []).length; i++) {\n\t\t\trelations = models[ i ].getRelations() || [];\n\n\t\t\tfor (let j = 0; j < relations.length; j++) {\n\t\t\t\trelation = relations[ j ];\n\n\t\t\t\tif (this._isReverseRelation(relation)) {\n\t\t\t\t\treverseRelations.push(relation);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn reverseRelations;\n\t},\n\n\t/**\n\t * When `this.instance` is destroyed, cleanup our relations.\n\t * Get reverse relation, call removeRelated on each.\n\t */\n\tdestroy() {\n\t\tthis.stopListening();\n\n\t\tif (this instanceof relationTypeStore.find('HasOne')) {\n\t\t\tthis.setRelated(null);\n\t\t} else if (this instanceof relationTypeStore.find('HasMany')) {\n\t\t\tthis.setRelated(this._prepareCollection());\n\t\t}\n\n\t\t_.each(this.getReverseRelations(), (relation) => {\n\t\t\trelation.removeRelated(this.instance);\n\t\t});\n\t}\n});\n","import { Model as BBModel } from 'backbone';\nimport _ from './utils/underscore-compat';\nimport Semaphore from './utils/semaphore';\nimport store from './store';\nimport eventQueue from './event-queue';\nimport BlockingQueue from './utils/blocking-queue';\nimport Relation from './relation';\nimport Collection from './collection';\nimport $ from 'jquery';\nimport relationTypeStore from './relation-type-store';\n\n/**\n * A type of Backbone.Model that also maintains relations to other models and collections.\n * New events when compared to the original:\n *  - 'add:<key>' (model, related collection, options)\n *  - 'remove:<key>' (model, related collection, options)\n *  - 'change:<key>' (model, related model or collection, options)\n */\nexport default BBModel.extend(Semaphore).extend({\n\trelations: null, // Relation descriptions on the prototype\n\t_relations: null, // Relation instances\n\t_isInitialized: false,\n\t_deferProcessing: false,\n\t_queue: null,\n\t_attributeChangeFired: false, // Keeps track of `change` event firing under some conditions (like nested `set`s)\n\n\tsubModelTypeAttribute: 'type',\n\tsubModelTypes: null,\n\n\tconstructor(attributes, options = {}) {\n\t\tconst { collection } = options;\n\t\t// Nasty hack, for cases like 'model.get( <HasMany key> ).add( item )'.\n\t\t// Defer 'processQueue', so that when 'Relation.createModels' is used we trigger 'HasMany'\n\t\t// collection events only after the model is really fully set up.\n\t\t// Example: event for \"p.on( 'add:jobs' )\" -> \"p.get('jobs').add( { company: c.id, person: p.id } )\".\n\t\tif (collection) {\n\t\t\tthis.collection = collection;\n\t\t\t// Prevent `collection` from cascading down to nested models; they shouldn't go into this `if` clause.\n\t\t\tdelete options.collection;\n\n\t\t\tthis._deferProcessing = true;\n\n\t\t\tconst processQueue = (model) => {\n\t\t\t\tif (model !== this) { return; }\n\n\t\t\t\tthis._deferProcessing = false;\n\t\t\t\tthis.processQueue();\n\t\t\t\tcollection.off('relational:add', processQueue);\n\t\t\t};\n\n\t\t\tthis.listenTo(collection, 'relational:add', processQueue);\n\n\t\t\t// So we do process the queue eventually, regardless of whether this model actually gets added to 'options.collection'.\n\t\t\t_.defer(() => {\n\t\t\t\tprocessQueue(this);\n\t\t\t});\n\t\t}\n\n\t\tstore.processOrphanRelations();\n\t\tstore.listenTo(this, 'relational:unregister', store.unregister);\n\n\t\tthis._queue = new BlockingQueue();\n\t\tthis._queue.block();\n\t\teventQueue.block();\n\n\t\ttry {\n\t\t\tBBModel.call(this, attributes, options);\n\t\t} finally {\n\t\t\t// Try to run the global queue holding external events\n\t\t\teventQueue.unblock();\n\t\t}\n\t},\n\n\t/**\n\t * Override 'trigger' to queue 'change' and 'change:*' events\n\t * @param {String} eventName name of event\n\t * @returns {this} this\n\t */\n\ttrigger(eventName) {\n\t\tconst args = _.toArray(arguments);\n\n\t\tif (eventName.length > 5 && eventName.indexOf('change') === 0) {\n\t\t\tif (!eventQueue.isLocked()) {\n\t\t\t\t// If we're not in a more complicated nested scenario, fire the change event right away\n\t\t\t\tBBModel.prototype.trigger.call(this, ...args);\n\t\t\t} else {\n\t\t\t\teventQueue.add(() => {\n\t\t\t\t\t// Determine if the `change` event is still valid, now that all relations are populated\n\t\t\t\t\tlet changed = true;\n\t\t\t\t\tif (eventName === 'change') {\n\t\t\t\t\t\t// `hasChanged` may have gotten reset by nested calls to `set`.\n\t\t\t\t\t\tchanged = this.hasChanged() || this._attributeChangeFired;\n\t\t\t\t\t\tthis._attributeChangeFired = false;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tlet attr = eventName.slice(7);\n\t\t\t\t\t\tlet rel = this.getRelation(attr);\n\n\t\t\t\t\t\tif (rel) {\n\t\t\t\t\t\t\t// If `attr` is a relation, `change:attr` get triggered from `Relation.onChange`.\n\t\t\t\t\t\t\t// These take precedence over `change:attr` events triggered by `Model.set`.\n\t\t\t\t\t\t\t// The relation sets a fourth attribute to `true`. If this attribute is present,\n\t\t\t\t\t\t\t// continue triggering this event; otherwise, it's from `Model.set` and should be stopped.\n\t\t\t\t\t\t\tchanged = (args[ 4 ] === true);\n\n\t\t\t\t\t\t\t// If this event was triggered by a relation, set the right value in `this.changed`\n\t\t\t\t\t\t\t// (a Collection or Model instead of raw data).\n\t\t\t\t\t\t\tif (changed) {\n\t\t\t\t\t\t\t\tthis.changed[ attr ] = args[ 2 ];\n\t\t\t\t\t\t\t} else if (!rel.changed) {\n\t\t\t\t\t\t\t\t// Otherwise, this event is from `Model.set`. If the relation doesn't report a change,\n\t\t\t\t\t\t\t\t// remove attr from `this.changed` so `hasChanged` doesn't take it into account.\n\t\t\t\t\t\t\t\tdelete this.changed[ attr ];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else if (changed) {\n\t\t\t\t\t\t\tthis._attributeChangeFired = true;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tchanged && BBModel.prototype.trigger.call(this, ...args);\n\t\t\t\t});\n\t\t\t}\n\t\t} else if (eventName === 'destroy') {\n\t\t\tBBModel.prototype.trigger.call(this, ...args);\n\t\t\tstore.unregister(this);\n\t\t} else {\n\t\t\tBBModel.prototype.trigger.call(this, ...args);\n\t\t}\n\n\t\treturn this;\n\t},\n\n\t/**\n\t * Initialize Relations present in this.relations; determine the type (HasOne/HasMany), then creates a new instance.\n\t * Invoked in the first call so 'set' (which is made from the Backbone.Model constructor).\n\t *\n\t * @param {Object} options Options to pass to relation\n\t */\n\tinitializeRelations(options) {\n\t\tthis.acquire(); // Setting up relations often also involve calls to 'set', and we only want to enter this function once\n\t\tthis._relations = {};\n\n\t\t_.each(this.relations || [], _.bind(function(rel) {\n\t\t\tstore.initializeRelation(this, rel, options);\n\t\t}, this));\n\n\t\tthis._isInitialized = true;\n\t\tthis.release();\n\t\tthis.processQueue();\n\t},\n\n\t/**\n\t * When new values are set, notify this model's relations (also if options.silent is set).\n\t * (called from `set`; Relation.setRelated locks this model before calling 'set' on it to prevent loops)\n\t *\n\t * @param {Object} [changedAttrs] Object representing changed attributes\n\t * @param {Object} [options] Options object passed along with relational:change event\n\t */\n\tupdateRelations(changedAttrs, options = {}) {\n\t\tif (this._isInitialized && !this.isLocked()) {\n\t\t\t_.each(this._relations, (rel) => {\n\t\t\t\tif (!changedAttrs || (rel.keySource in changedAttrs || rel.key in changedAttrs)) {\n\t\t\t\t\t// Fetch data in `rel.keySource` if data got set in there, or `rel.key` otherwise\n\t\t\t\t\tlet value = this.attributes[ rel.keySource ] || this.attributes[ rel.key ];\n\t\t\t\t\tlet attr = changedAttrs && (changedAttrs[ rel.keySource ] || changedAttrs[ rel.key ]);\n\n\t\t\t\t\t// Update a relation if its value differs from this model's attributes, or it's been explicitly nullified.\n\t\t\t\t\t// Which can also happen before the originally intended related model has been found (`val` is null).\n\t\t\t\t\tif (rel.related !== value || (value === null && attr === null)) {\n\t\t\t\t\t\tthis.trigger('relational:change:' + rel.key, this, value, options);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Explicitly clear 'keySource', to prevent a leaky abstraction if 'keySource' differs from 'key'.\n\t\t\t\tif (rel.keySource !== rel.key) {\n\t\t\t\t\tdelete this.attributes[ rel.keySource ];\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\n\t/**\n\t * Either add to the queue (if we're not initialized yet), or execute right away.\n\t * @param {Function} [func] Function to defer execution\n\t */\n\tqueue(func) {\n\t\tthis._queue.add(func);\n\t},\n\n\t/**\n\t * Process _queue\n\t */\n\tprocessQueue() {\n\t\tif (this._isInitialized && !this._deferProcessing && this._queue.isBlocked()) {\n\t\t\tthis._queue.unblock();\n\t\t}\n\t},\n\n\t/**\n\t * Get a specific relation.\n\t * @param {string} attr The relation key to look for.\n\t * @return {Backbone.Relation} An instance of 'Backbone.Relation', if a relation was found for 'attr', or null.\n\t */\n\tgetRelation(attr) {\n\t\treturn this._relations[ attr ];\n\t},\n\n\t/**\n\t * Get all of the created relations.\n\t * @return {Backbone.Relation[]} Array of relationships\n\t */\n\tgetRelations() {\n\t\treturn _.values(this._relations);\n\t},\n\n\t/**\n\t * Get a list of ids that will be fetched on a call to `getAsync`.\n\t * @param {string|Backbone.Relation} attr The relation key to fetch models for.\n\t * @param {Boolean} [refresh=false] Add ids for models that are already in the relation, refreshing them?\n\t * @return {Array} An array of ids that need to be fetched.\n\t */\n\tgetIdsToFetch(attr, refresh = false) {\n\t\tlet rel = attr instanceof Relation ? attr : this.getRelation(attr);\n\t\tlet ids = rel ? (rel.keyIds && rel.keyIds.slice(0)) || ((rel.keyId || rel.keyId === 0) ? [rel.keyId] : []) : [];\n\n\t\t// On `refresh`, add the ids for current models in the relation to `idsToFetch`\n\t\tif (refresh) {\n\t\t\tlet models = rel.related && (rel.related.models || [rel.related]);\n\t\t\t_.each(models, function(model) {\n\t\t\t\tif (model.id || model.id === 0) {\n\t\t\t\t\tids.push(model.id);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\treturn ids;\n\t},\n\n\t/**\n\t * Get related objects. Returns a single promise, which can either resolve immediately (if the related model[s])\n\t * are already present locally, or after fetching the contents of the requested attribute.\n\t * @param {string} attr The relation key to fetch models for.\n\t * @param {Object} [options] Options for 'Backbone.Model.fetch' and 'Backbone.sync'.\n\t * @param {Boolean} [options.refresh=false] Fetch existing models from the server as well (in order to update them).\n\t * @return {jQuery.Deferred} A jQuery promise object. When resolved, its `done` callback will be called with\n\t *  contents of `attr`.\n\t */\n\tgetAsync(attr, options) {\n\t\t// Set default `options` for fetch\n\t\toptions = _.extend({ add: true, remove: false, refresh: false }, options);\n\n\t\tlet requests = [];\n\t\tlet rel = this.getRelation(attr);\n\t\tlet idsToFetch = rel && this.getIdsToFetch(rel, options.refresh);\n\t\tlet coll = rel.related instanceof Collection ? rel.related : rel.relatedCollection;\n\n\t\tif (idsToFetch && idsToFetch.length) {\n\t\t\tlet models = [];\n\t\t\tlet createdModels = [];\n\t\t\tlet setUrl;\n\t\t\tfunction createModels() {\n\t\t\t\t// Find (or create) a model for each one that is to be fetched\n\t\t\t\tmodels = _.map(idsToFetch, (id) => {\n\t\t\t\t\tlet model = rel.relatedModel.findModel(id);\n\n\t\t\t\t\tif (!model) {\n\t\t\t\t\t\tlet attrs = {};\n\t\t\t\t\t\tattrs[ rel.relatedModel.prototype.idAttribute ] = id;\n\t\t\t\t\t\tmodel = rel.relatedModel.findOrCreate(attrs, options);\n\t\t\t\t\t\tcreatedModels.push(model);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn model;\n\t\t\t\t});\n\t\t\t};\n\n\t\t\t// Try if the 'collection' can provide a url to fetch a set of models in one request.\n\t\t\t// This assumes that when 'Collection.url' is a function, it can handle building of set urls.\n\t\t\t// To make sure it can, test if the url we got by supplying a list of models to fetch is different from\n\t\t\t// the one supplied for the default fetch action (without args to 'url').\n\t\t\tif (coll instanceof Collection && _.isFunction(coll.url)) {\n\t\t\t\tlet defaultUrl = coll.url();\n\t\t\t\tsetUrl = coll.url(idsToFetch);\n\n\t\t\t\tif (setUrl === defaultUrl) {\n\t\t\t\t\tcreateModels();\n\t\t\t\t\tsetUrl = coll.url(models);\n\n\t\t\t\t\tif (setUrl === defaultUrl) {\n\t\t\t\t\t\tsetUrl = null;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (setUrl) {\n\t\t\t\t// Do a single request to fetch all models\n\t\t\t\tlet opts = _.defaults({\n\t\t\t\t\turl: setUrl,\n\t\t\t\t\terror(...args) {\n\t\t\t\t\t\t_.each(createdModels, function(model) {\n\t\t\t\t\t\t\tmodel.trigger('destroy', model, model.collection, options);\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tif (options.error) {\n\t\t\t\t\t\t\toptions.error.call(this, ...args)\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}, options);\n\n\t\t\t\trequests = [coll.fetch(opts)];\n\t\t\t} else {\n\t\t\t\t// Make a request per model to fetch\n\t\t\t\tif (!models.length) {\n\t\t\t\t\tcreateModels();\n\t\t\t\t}\n\n\t\t\t\trequests = _.map(models, _.bind(function(model) {\n\t\t\t\t\tlet opts = _.defaults({\n\t\t\t\t\t\terror(...args) {\n\t\t\t\t\t\t\tif (_.contains(createdModels, model)) {\n\t\t\t\t\t\t\t\tmodel.trigger('destroy', model, model.collection, options);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif (options.error) {\n\t\t\t\t\t\t\t\toptions.error.call(this, ...args);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}, options);\n\n\t\t\t\t\treturn model.fetch(opts);\n\t\t\t\t}, this));\n\t\t\t}\n\t\t}\n\n\t\treturn this.deferArray(requests).then(() => {\n\t\t\treturn BBModel.prototype.get.call(this, attr);\n\t\t});\n\t},\n\n\tdeferArray(deferArray) {\n\t\treturn $.when(...deferArray);\n\t},\n\n\tset(key, value, options) {\n\t\tconst args = _.toArray(arguments);\n\n\t\teventQueue.block();\n\n\t\t// Duplicate backbone's behavior to allow separate key/value parameters, instead of a single 'attributes' object\n\t\tlet attributes;\n\t\tlet result;\n\n\t\tif (_.isObject(key) || key == null) {\n\t\t\tattributes = key;\n\t\t\toptions = value;\n\t\t} else {\n\t\t\tattributes = {};\n\t\t\tattributes[ key ] = value;\n\t\t}\n\n\t\ttry {\n\t\t\tlet id = this.id;\n\t\t\tlet newId = attributes && this.idAttribute in attributes && attributes[ this.idAttribute ];\n\n\t\t\t// Check if we're not setting a duplicate id before actually calling `set`.\n\t\t\tstore.checkId(this, newId);\n\n\t\t\tresult = BBModel.prototype.set.call(this, ...args);\n\n\t\t\t// Ideal place to set up relations, if this is the first time we're here for this model\n\t\t\tif (!this._isInitialized && !this.isLocked()) {\n\t\t\t\tthis.constructor.initializeModelHierarchy();\n\n\t\t\t\t// Only register models that have an id. A model will be registered when/if it gets an id later on.\n\t\t\t\tif (newId || newId === 0) {\n\t\t\t\t\tstore.register(this);\n\t\t\t\t}\n\n\t\t\t\tthis.initializeRelations(options);\n\t\t\t} else if (newId && newId !== id) {\n\t\t\t\t// The store should know about an `id` update asap\n\t\t\t\tstore.update(this);\n\t\t\t}\n\n\t\t\tif (attributes) {\n\t\t\t\tthis.updateRelations(attributes, options);\n\t\t\t}\n\t\t} finally {\n\t\t\t// Try to run the global queue holding external events\n\t\t\teventQueue.unblock();\n\t\t}\n\n\t\treturn result;\n\t},\n\n\tclone() {\n\t\tlet attributes = _.clone(this.attributes);\n\t\tif (!_.isUndefined(attributes[ this.idAttribute ])) {\n\t\t\tattributes[ this.idAttribute ] = null;\n\t\t}\n\n\t\t_.each(this.getRelations(), function(rel) {\n\t\t\tdelete attributes[ rel.key ];\n\t\t});\n\n\t\treturn new this.constructor(attributes);\n\t},\n\n\t/**\n\t * Convert relations to JSON, omits them when required\n\t * @param {Object} [options] Options\n\t */\n\ttoJSON(options) {\n\t\t// If this Model has already been fully serialized in this branch once, return to avoid loops\n\t\tif (this.isLocked()) {\n\t\t\treturn this.id;\n\t\t}\n\n\t\tthis.acquire();\n\t\tlet json = BBModel.prototype.toJSON.call(this, options);\n\n\t\tif (this.constructor._superModel && !(this.constructor._subModelTypeAttribute in json)) {\n\t\t\tjson[ this.constructor._subModelTypeAttribute ] = this.constructor._subModelTypeValue;\n\t\t}\n\n\t\t_.each(this._relations, function(rel) {\n\t\t\tlet related = json[ rel.key ];\n\t\t\tlet includeInJSON = rel.options.includeInJSON;\n\t\t\tlet value = null;\n\n\t\t\tif (includeInJSON === true) {\n\t\t\t\tif (related && _.isFunction(related.toJSON)) {\n\t\t\t\t\tvalue = related.toJSON(options);\n\t\t\t\t}\n\t\t\t} else if (_.isString(includeInJSON)) {\n\t\t\t\tif (related instanceof Collection) {\n\t\t\t\t\tvalue = related.pluck(includeInJSON);\n\t\t\t\t} else if (related instanceof BBModel) {\n\t\t\t\t\tvalue = related.get(includeInJSON);\n\t\t\t\t}\n\n\t\t\t\t// Add ids for 'unfound' models if includeInJSON is equal to (only) the relatedModel's `idAttribute`\n\t\t\t\tif (includeInJSON === rel.relatedModel.prototype.idAttribute) {\n\t\t\t\t\tif (rel instanceof relationTypeStore.find('HasMany')) {\n\t\t\t\t\t\tvalue = value.concat(rel.keyIds);\n\t\t\t\t\t} else if (rel instanceof relationTypeStore.find('HasOne')) {\n\t\t\t\t\t\tvalue = value || rel.keyId;\n\n\t\t\t\t\t\tif (!value && !_.isObject(rel.keyContents)) {\n\t\t\t\t\t\t\tvalue = rel.keyContents || null;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else if (_.isArray(includeInJSON)) {\n\t\t\t\tif (related instanceof Collection) {\n\t\t\t\t\tvalue = [];\n\t\t\t\t\trelated.each(function(model) {\n\t\t\t\t\t\tlet curJson = {};\n\t\t\t\t\t\t_.each(includeInJSON, function(key) {\n\t\t\t\t\t\t\tcurJson[ key ] = model.get(key);\n\t\t\t\t\t\t});\n\t\t\t\t\t\tvalue.push(curJson);\n\t\t\t\t\t});\n\t\t\t\t} else if (related instanceof BBModel) {\n\t\t\t\t\tvalue = {};\n\t\t\t\t\t_.each(includeInJSON, function(key) {\n\t\t\t\t\t\tvalue[ key ] = related.get(key);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tdelete json[ rel.key ];\n\t\t\t}\n\n\t\t\t// In case of `wait: true`, Backbone will simply push whatever's passed into `save` into attributes.\n\t\t\t// We'll want to get this information into the JSON, even if it doesn't conform to our normal\n\t\t\t// expectations of what's contained in it (no model/collection for a relation, etc).\n\t\t\tif (value === null && options && options.wait) {\n\t\t\t\tvalue = related;\n\t\t\t}\n\n\t\t\tif (includeInJSON) {\n\t\t\t\tjson[ rel.keyDestination ] = value;\n\t\t\t}\n\n\t\t\tif (rel.keyDestination !== rel.key) {\n\t\t\t\tdelete json[ rel.key ];\n\t\t\t}\n\t\t});\n\n\t\tthis.release();\n\t\treturn json;\n\t}\n}, {\n\t/**\n\t *\n\t * @param superModel\n\t * @returns {Backbone.Relational.Model.constructor}\n\t */\n\tsetup(superModel) {\n\t\t// We don't want to share a relations array with a parent, as this will cause problems with reverse\n\t\t// relations. Since `relations` may also be a property or function, only use slice if we have an array.\n\t\tthis.prototype.relations = (this.prototype.relations || []).slice(0);\n\n\t\tthis._subModels = {};\n\t\tthis._superModel = null;\n\n\t\t// If this model has 'subModelTypes' itself, remember them in the store\n\t\tif (this.prototype.hasOwnProperty('subModelTypes')) {\n\t\t\tstore.addSubModels(this.prototype.subModelTypes, this);\n\t\t} else {\n\t\t\t// The 'subModelTypes' property should not be inherited, so reset it.\n\t\t\tthis.prototype.subModelTypes = null;\n\t\t}\n\n\t\t// Initialize all reverseRelations that belong to this new model.\n\t\t_.each(this.prototype.relations || [], (rel) => {\n\t\t\tif (!rel.model) {\n\t\t\t\trel.model = this;\n\t\t\t}\n\n\t\t\tif (rel.reverseRelation && rel.model === this) {\n\t\t\t\tlet preInitialize = true;\n\t\t\t\tif (_.isString(rel.relatedModel)) {\n\t\t\t\t/**\n\t\t\t\t * The related model might not be defined for two reasons\n\t\t\t\t *  1. it is related to itself\n\t\t\t\t *  2. it never gets defined, e.g. a typo\n\t\t\t\t *  3. the model hasn't been defined yet, but will be later\n\t\t\t\t * In neither of these cases do we need to pre-initialize reverse relations.\n\t\t\t\t * However, for 3. (which is, to us, indistinguishable from 2.), we do need to attempt\n\t\t\t\t * setting up this relation again later, in case the related model is defined later.\n\t\t\t\t */\n\t\t\t\t\tlet relatedModel = store.getObjectByName(rel.relatedModel);\n\t\t\t\t\tpreInitialize = relatedModel && (relatedModel.prototype instanceof this);\n\t\t\t\t}\n\n\t\t\t\tif (preInitialize) {\n\t\t\t\t\tstore.initializeRelation(null, rel);\n\t\t\t\t} else if (_.isString(rel.relatedModel)) {\n\t\t\t\t\tstore.addOrphanRelation(rel);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\treturn this;\n\t},\n\n\t/**\n\t * Create a 'Backbone.Model' instance based on 'attributes'.\n\t * @param {Object} [attributes] Attributes to set\n\t * @param {Object} [options] Options\n\t * @return {Backbone.Model}\n\t */\n\tbuild(attributes, options) {\n\t\t// 'build' is a possible entrypoint; it's possible no model hierarchy has been determined yet.\n\t\tthis.initializeModelHierarchy();\n\n\t\t// Determine what type of (sub)model should be built if applicable.\n\t\tlet Model = this._findSubModelType(this, attributes) || this;\n\n\t\treturn new Model(attributes, options);\n\t},\n\n\t/**\n\t * Determines what type of (sub)model should be built if applicable.\n\t * Looks up the proper subModelType in 'this._subModels', recursing into\n\t * types until a match is found.  Returns the applicable 'Backbone.Model'\n\t * or null if no match is found.\n\t * @param {Backbone.Model} type\n\t * @param {Object} attributes\n\t * @return {Backbone.Model}\n\t */\n\t_findSubModelType(type, attributes) {\n\t\tif (type._subModels && type.prototype.subModelTypeAttribute in attributes) {\n\t\t\tlet subModelTypeAttribute = attributes[ type.prototype.subModelTypeAttribute ];\n\t\t\tlet subModelType = type._subModels[ subModelTypeAttribute ];\n\t\t\tif (subModelType) {\n\t\t\t\treturn subModelType;\n\t\t\t} else {\n\t\t\t\t// Recurse into subModelTypes to find a match\n\t\t\t\tfor (subModelTypeAttribute in type._subModels) {\n\t\t\t\t\tsubModelType = this._findSubModelType(type._subModels[ subModelTypeAttribute ], attributes);\n\t\t\t\t\tif (subModelType) {\n\t\t\t\t\t\treturn subModelType;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t},\n\n\tinitializeModelHierarchy() {\n\t\t// Inherit any relations that have been defined in the parent model.\n\t\tthis.inheritRelations();\n\n\t\t// If we came here through 'build' for a model that has 'subModelTypes' then try to initialize the ones that\n\t\t// haven't been resolved yet.\n\t\tif (this.prototype.subModelTypes) {\n\t\t\tlet resolvedSubModels = _.keys(this._subModels);\n\t\t\tlet unresolvedSubModels = _.omit(this.prototype.subModelTypes, resolvedSubModels);\n\t\t\t_.each(unresolvedSubModels, function(subModelTypeName) {\n\t\t\t\tlet subModelType = store.getObjectByName(subModelTypeName);\n\t\t\t\tsubModelType && subModelType.initializeModelHierarchy();\n\t\t\t});\n\t\t}\n\t},\n\n\tinheritRelations() {\n\t\t// Bail out if we've been here before.\n\t\tif (!_.isUndefined(this._superModel) && !_.isNull(this._superModel)) {\n\t\t\treturn;\n\t\t}\n\t\t// Try to initialize the _superModel.\n\t\tstore.setupSuperModel(this);\n\n\t\t// If a superModel has been found, copy relations from the _superModel if they haven't been inherited automatically\n\t\t// (due to a redefinition of 'relations').\n\t\tif (this._superModel) {\n\t\t// The _superModel needs a chance to initialize its own inherited relations before we attempt to inherit relations\n\t\t// from the _superModel. You don't want to call 'initializeModelHierarchy' because that could cause sub-models of\n\t\t// this class to inherit their relations before this class has had chance to inherit it's relations.\n\t\t\tthis._superModel.inheritRelations();\n\t\t\tif (this._superModel.prototype.relations) {\n\t\t\t// Find relations that exist on the '_superModel', but not yet on this model.\n\t\t\t\tlet inheritedRelations = _.filter(this._superModel.prototype.relations || [], _.bind(function(superRel) {\n\t\t\t\t\treturn !_.any(this.prototype.relations || [], _.bind(function(rel) {\n\t\t\t\t\t\treturn superRel.relatedModel === rel.relatedModel && superRel.key === rel.key;\n\t\t\t\t\t}, this));\n\t\t\t\t}, this));\n\n\t\t\t\tthis.prototype.relations = inheritedRelations.concat(this.prototype.relations);\n\t\t\t}\n\t\t} else {\n\t\t\t// Otherwise, make sure we don't get here again for this type by making '_superModel' false so we fail the\n\t\t\t// isUndefined/isNull check next time.\n\t\t\tthis._superModel = false;\n\t\t}\n\t},\n\n\t/**\n\t * Find an instance of `this` type in 'Backbone.store'.\n\t * A new model is created if no matching model is found, `attributes` is an object, and `options.create` is true.\n\t * - If `attributes` is a string or a number, `findOrCreate` will query the `store` and return a model if found.\n\t * - If `attributes` is an object and is found in the store, the model will be updated with `attributes` unless `options.merge` is `false`.\n\t * @param {Object|String|Number} attributes Either a model's id, or the attributes used to create or update a model.\n\t * @param {Object} [options]\n\t * @param {Boolean} [options.create=true]\n\t * @param {Boolean} [options.merge=true]\n\t * @param {Boolean} [options.parse=false]\n\t * @return {Backbone.Relational.Model}\n\t */\n\tfindOrCreate(attributes, options) {\n\t\toptions || (options = {});\n\t\tlet parsedAttributes = (_.isObject(attributes) && options.parse && this.prototype.parse) ?\n\t\tthis.prototype.parse(_.clone(attributes), options) : attributes;\n\n\t\t// If specified, use a custom `find` function to match up existing models to the given attributes.\n\t\t// Otherwise, try to find an instance of 'this' model type in the store\n\t\tlet model = this.findModel(parsedAttributes);\n\n\t\t// If we found an instance, update it with the data in 'item' (unless 'options.merge' is false).\n\t\t// If not, create an instance (unless 'options.create' is false).\n\t\tif (_.isObject(attributes)) {\n\t\t\tif (model && options.merge !== false) {\n\t\t\t// Make sure `options.collection` and `options.url` doesn't cascade to nested models\n\t\t\t\tdelete options.collection;\n\t\t\t\tdelete options.url;\n\n\t\t\t\tmodel.set(parsedAttributes, options);\n\t\t\t} else if (!model && options.create !== false) {\n\t\t\t\tmodel = this.build(parsedAttributes, _.defaults({ parse: false }, options));\n\t\t\t}\n\t\t}\n\n\t\treturn model;\n\t},\n\n\t/**\n\t * Find an instance of `this` type in 'Backbone.store'.\n\t * - If `attributes` is a string or a number, `find` will query the `store` and return a model if found.\n\t * - If `attributes` is an object and is found in the store, the model will be updated with `attributes` unless `options.merge` is `false`.\n\t * @param {Object|String|Number} attributes Either a model's id, or the attributes used to create or update a model.\n\t * @param {Object} [options]\n\t * @param {Boolean} [options.merge=true]\n\t * @param {Boolean} [options.parse=false]\n\t * @return {Backbone.Relational.Model}\n\t */\n\tfind(attributes, options) {\n\t\toptions || (options = {});\n\t\toptions.create = false;\n\t\treturn this.findOrCreate(attributes, options);\n\t},\n\n\t/**\n\t * A hook to override the matching when updating (or creating) a model.\n\t * The default implementation is to look up the model by id in the store.\n\t * @param {Object} attributes\n\t * @returns {Backbone.Relational.Model}\n\t */\n\tfindModel(attributes) {\n\t\treturn store.find(this, attributes);\n\t},\n\n\t// Override .extend() to automatically call .setup()\n\textend(protoProps, classProps) {\n\t\tlet child = BBModel.extend.call(this, protoProps, classProps);\n\t\tchild.setup(this);\n\t\treturn child;\n\t}\n});\n","import { Collection as BBCollection, Model as BBModel } from 'backbone';\nimport Model from './model';\nimport _ from './utils/underscore-compat';\nimport eventQueue from './event-queue';\n\nexport default BBCollection.extend({\n\t/**\n\t * Override module.Collection._prepareModel, so objects will be built using the correct type\n\t * if the collection.model has subModels.\n\t * Attempts to find a model for `attrs` in Backbone.store through `findOrCreate`\n\t * (which sets the new properties on it if found), or instantiates a new model.\n\t */\n\t_prepareModel(attrs, options) {\n\t\tlet model;\n\n\t\tif (attrs instanceof BBModel) {\n\t\t\tif (!attrs.collection) {\n\t\t\t\tattrs.collection = this;\n\t\t\t}\n\t\t\tmodel = attrs;\n\t\t} else {\n\t\t\toptions = options ? _.clone(options) : {};\n\t\t\toptions.collection = this;\n\n\t\t\tif (typeof this.model.findOrCreate !== 'undefined') {\n\t\t\t\tmodel = this.model.findOrCreate(attrs, options);\n\t\t\t} else {\n\t\t\t\tconst TargetModel = this.model;\n\t\t\t\tmodel = new TargetModel(attrs, options);\n\t\t\t}\n\n\t\t\tif (model && model.validationError) {\n\t\t\t\tthis.trigger('invalid', this, attrs, options);\n\t\t\t\tmodel = false;\n\t\t\t}\n\t\t}\n\n\t\treturn model;\n\t},\n\t/**\n\t * Override module.Collection.set, so we'll create objects from attributes where required,\n\t * and update the existing models. Also, trigger 'relational:add'.\n\t */\n\tset(models, options) {\n\t\t// Short-circuit if this Collection doesn't hold RelationalModels\n\t\tif (!this.model.prototype instanceof Model) {\n\t\t\treturn BBCollection.prototype.set.call(this, models, options);\n\t\t}\n\n\t\tif (options && options.parse) {\n\t\t\tmodels = this.parse(models, options);\n\t\t}\n\n\t\tlet singular = !_.isArray(models);\n\t\tlet newModels = [];\n\t\tlet toAdd = [];\n\t\tlet model = null;\n\n\t\tmodels = singular ? (models ? [models] : []) : _.clone(models);\n\n\t\t//console.debug( 'calling add on coll=%o; model=%o, options=%o', this, models, options );\n\t\tfor (let i = 0; i < models.length; i++) {\n\t\t\tmodel = models[i];\n\t\t\tif (!(model instanceof BBModel)) {\n\t\t\t\tmodel = this._prepareModel(model, options);\n\t\t\t}\n\n\t\t\tif (model) {\n\t\t\t\ttoAdd.push(model);\n\n\t\t\t\tif (!(this.get(model) || this.get(model.cid))) {\n\t\t\t\t\tnewModels.push(model);\n\t\t\t\t} else if (model.id != null) {\n\t\t\t\t\t// If we arrive in `add` while performing a `set` (after a create, so the model gains an `id`),\n\t\t\t\t\t// we may get here before `_onModelEvent` has had the chance to update `_byId`.\n\t\t\t\t\tthis._byId[ model.id ] = model;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Add 'models' in a single batch, so the original add will only be called once (and thus 'sort', etc).\n\t\t// If `parse` was specified, the collection and contained models have been parsed now.\n\t\ttoAdd = singular ? (toAdd.length ? toAdd[ 0 ] : null) : toAdd;\n\t\tlet result = BBCollection.prototype.set.call(this, toAdd, _.defaults({ merge: false, parse: false }, options));\n\n\t\tfor (let i = 0; i < newModels.length; i++) {\n\t\t\tmodel = newModels[i];\n\t\t\t// Fire a `relational:add` event for any model in `newModels` that has actually been added to the collection.\n\t\t\tif (this.get(model) || this.get(model.cid)) {\n\t\t\t\tthis.trigger('relational:add', model, this, options);\n\t\t\t}\n\t\t}\n\n\t\treturn result;\n\t},\n\t/**\n\t * Override 'module.Collection.trigger' so 'add', 'remove' and 'reset' events are queued until relations\n\t * are ready.\n\t * @param {String} [eventName] Name of of event\n\t */\n\ttrigger(eventName) {\n\t\tconst args = _.toArray(arguments);\n\n\t\t// Short-circuit if this Collection doesn't hold RelationalModels\n\t\tif (!(this.model.prototype instanceof Model)) {\n\t\t\treturn BBCollection.prototype.trigger.call(this, ...args);\n\t\t}\n\n\t\tif (eventName === 'add' || eventName === 'remove' || eventName === 'reset' || eventName === 'sort') {\n\t\t\tif (_.isObject(args[ 3 ])) {\n\t\t\t\t// the fourth argument is the option object.\n\t\t\t\t// we need to clone it, as it could be modified while we wait on the eventQueue to be unblocked\n\t\t\t\targs[ 3 ] = _.clone(args[ 3 ]);\n\t\t\t}\n\n\t\t\teventQueue.add(() => {\n\t\t\t\tBBCollection.prototype.trigger.call(this, ...args);\n\t\t\t});\n\t\t} else {\n\t\t\tBBCollection.prototype.trigger.call(this, ...args);\n\t\t}\n\n\t\treturn this;\n\t},\n\t/**\n\t * Override 'module.Collection.sort' to trigger 'relational:reset'.\n\t */\n\tsort(options) {\n\t\tlet result = BBCollection.prototype.sort.call(this, options);\n\n\t\tif (this.model.prototype instanceof Model) {\n\t\t\tthis.trigger('relational:reset', this, options);\n\t\t}\n\n\t\treturn result;\n\t},\n\t/**\n\t * Override 'module.Collection.reset' to trigger 'relational:reset'.\n\t */\n\treset(models, options) {\n\t\toptions = _.extend({ merge: true }, options);\n\t\tlet result = BBCollection.prototype.reset.call(this, models, options);\n\n\t\tif (this.model.prototype instanceof Model) {\n\t\t\tthis.trigger('relational:reset', this, options);\n\t\t}\n\n\t\treturn result;\n\t},\n\t/**\n\t * Override 'Backbone.Collection._removeModels' to trigger 'relational:remove'.\n\t */\n\t_removeModels(models, options) {\n\t\t// Short-circuit if this Collection doesn't hold RelationalModels\n\t\t// if ( !( this.model.prototype instanceof module.Model ) ) {\n\t\t// \treturn _removeModels.call( this, models, options );\n\t\t// }\n\n\t\tlet toRemove = [];\n\n\t\t//console.debug('calling remove on coll=%o; models=%o, options=%o', this, models, options );\n\t\t_.each(models, (model) => {\n\t\t\tmodel = this.get(model) || (model && this.get(model.cid));\n\t\t\tmodel && toRemove.push(model);\n\t\t});\n\n\t\tlet result = BBCollection.prototype._removeModels.call(this, toRemove, options);\n\n\t\t_.each(toRemove, (model) => {\n\t\t\tthis.trigger('relational:remove', model, this, options);\n\t\t});\n\n\t\treturn result;\n\t}\n});\n","import _ from './utils/underscore-compat';\nimport Relation from './relation';\nimport store from './store';\nimport eventQueue from './event-queue';\n\nexport default Relation.extend({\n\toptions: {\n\t\treverseRelation: { type: 'HasMany' }\n\t},\n\n\tinitialize(opts) {\n\t\tthis.listenTo(this.instance, 'relational:change:' + this.key, this.onChange);\n\n\t\tlet related = this.findRelated(opts);\n\t\tthis.setRelated(related);\n\n\t\t// Notify new 'related' object of the new relation.\n\t\t_.each(this.getReverseRelations(), (relation) => {\n\t\t\trelation.addRelated(this.instance, opts);\n\t\t});\n\t},\n\n\t/**\n\t * Find related Models.\n\t * @param {Object} [options]\n\t * @return {Backbone.Model}\n\t */\n\tfindRelated(options) {\n\t\tlet related = null;\n\n\t\toptions = _.defaults({ parse: this.options.parse }, options);\n\n\t\tif (this.keyContents instanceof this.relatedModel) {\n\t\t\trelated = this.keyContents;\n\t\t} else if (this.keyContents || this.keyContents === 0) { // since 0 can be a valid `id` as well\n\t\t\tlet opts = _.defaults({ create: this.options.createModels }, options);\n\t\t\trelated = this.relatedModel.findOrCreate(this.keyContents, opts);\n\t\t}\n\n\t\t// Nullify `keyId` if we have a related model; in case it was already part of the relation\n\t\tif (related) {\n\t\t\tthis.keyId = null;\n\t\t}\n\n\t\treturn related;\n\t},\n\n\t/**\n\t * Normalize and reduce `keyContents` to an `id`, for easier comparison\n\t * @param {String|Number|Backbone.Model} keyContents\n\t */\n\tsetKeyContents(keyContents) {\n\t\tthis.keyContents = keyContents;\n\t\tthis.keyId = store.resolveIdForItem(this.relatedModel, this.keyContents);\n\t},\n\n\t/**\n\t * Event handler for `change:<key>`.\n\t * If the key is changed, notify old & new reverse relations and initialize the new relation.\n\t */\n\tonChange(model, attr, options) {\n\t\t// Don't accept recursive calls to onChange (like onChange->findRelated->findOrCreate->initializeRelations->addRelated->onChange)\n\t\tif (this.isLocked()) {\n\t\t\treturn;\n\t\t}\n\t\tthis.acquire();\n\t\toptions = options ? _.clone(options) : {};\n\n\t\t// 'options.__related' is set by 'addRelated'/'removeRelated'. If it is set, the change\n\t\t// is the result of a call from a relation. If it's not, the change is the result of\n\t\t// a 'set' call on this.instance.\n\t\tlet changed = _.isUndefined(options.__related);\n\t\tlet oldRelated = changed ? this.related : options.__related;\n\n\t\tif (changed) {\n\t\t\tthis.setKeyContents(attr);\n\t\t\tlet related = this.findRelated(options);\n\t\t\tthis.setRelated(related);\n\t\t}\n\n\t\t// Notify old 'related' object of the terminated relation\n\t\tif (oldRelated && this.related !== oldRelated) {\n\t\t\t_.each(this.getReverseRelations(oldRelated), (relation) => {\n\t\t\t\trelation.removeRelated(this.instance, null, options);\n\t\t\t});\n\t\t}\n\n\t\t// Notify new 'related' object of the new relation. Note we do re-apply even if this.related is oldRelated;\n\t\t// that can be necessary for bi-directional relations if 'this.instance' was created after 'this.related'.\n\t\t// In that case, 'this.instance' will already know 'this.related', but the reverse might not exist yet.\n\t\t_.each(this.getReverseRelations(), (relation) => {\n\t\t\trelation.addRelated(this.instance, options);\n\t\t});\n\n\t\t// Fire the 'change:<key>' event if 'related' was updated\n\t\tif (!options.silent && this.related !== oldRelated) {\n\t\t\tthis.changed = true;\n\t\t\teventQueue.add(() => {\n\t\t\t\tthis.instance.trigger('change:' + this.key, this.instance, this.related, options, true);\n\t\t\t\tthis.changed = false;\n\t\t\t});\n\t\t}\n\t\tthis.release();\n\t},\n\n\t/**\n\t * If a new 'this.relatedModel' appears in the 'store', try to match it to the last set 'keyContents'\n\t */\n\ttryAddRelated(model, coll, options) {\n\t\tif ((this.keyId || this.keyId === 0) && model.id === this.keyId) { // since 0 can be a valid `id` as well\n\t\t\tthis.addRelated(model, options);\n\t\t\tthis.keyId = null;\n\t\t}\n\t},\n\n\taddRelated(model, options) {\n\t\t// Allow 'model' to set up its relations before proceeding.\n\t\t// (which can result in a call to 'addRelated' from a relation of 'model')\n\t\tmodel.queue(() => {\n\t\t\tif (model !== this.related) {\n\t\t\t\tlet oldRelated = this.related || null;\n\t\t\t\tthis.setRelated(model);\n\t\t\t\tthis.onChange(this.instance, model, _.defaults({ __related: oldRelated }, options));\n\t\t\t}\n\t\t});\n\t},\n\n\tremoveRelated(model, coll, options) {\n\t\tif (!this.related) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (model === this.related) {\n\t\t\tlet oldRelated = this.related || null;\n\t\t\tthis.setRelated(null);\n\t\t\tthis.onChange(this.instance, model, _.defaults({ __related: oldRelated }, options));\n\t\t}\n\t}\n});\n","import _ from './utils/underscore-compat';\nimport Relation from './relation';\nimport store from './store';\nimport eventQueue from './event-queue';\nimport Collection from './collection';\nimport config from './config';\n\nexport default Relation.extend({\n\tcollectionType: null,\n\n\toptions: {\n\t\treverseRelation: { type: 'HasOne' },\n\t\tcollectionType: Collection,\n\t\tcollectionKey: true,\n\t\tcollectionOptions: {}\n\t},\n\n\tinitialize(opts) {\n\t\tthis.listenTo(this.instance, 'relational:change:' + this.key, this.onChange);\n\n\t\t// Handle a custom 'collectionType'\n\t\tthis.collectionType = this.options.collectionType;\n\t\tif (_.isFunction(this.collectionType) && this.collectionType !== Collection && !(this.collectionType.prototype instanceof Collection)) {\n\t\t\tthis.collectionType = _.result(this, 'collectionType');\n\t\t}\n\t\tif (_.isString(this.collectionType)) {\n\t\t\tthis.collectionType = store.getObjectByName(this.collectionType);\n\t\t}\n\t\tif (this.collectionType !== Collection && !(this.collectionType.prototype instanceof Collection)) {\n\t\t\tthrow new Error('`collectionType` must inherit from Collection');\n\t\t}\n\n\t\tlet related = this.findRelated(opts);\n\t\tthis.setRelated(related);\n\t},\n\n\t/**\n\t * Bind events and setup collectionKeys for a collection that is to be used as the backing store for a HasMany.\n\t * If no 'collection' is supplied, a new collection will be created of the specified 'collectionType' option.\n\t * @param {Collection} [collection]\n\t * @return {Collection}\n\t */\n\t_prepareCollection(collection) {\n\t\tif (this.related) {\n\t\t\tthis.stopListening(this.related);\n\t\t}\n\n\t\tif (!collection || !(collection instanceof Collection)) {\n\t\t\tlet options = _.isFunction(this.options.collectionOptions) ?\n\t\t\t\tthis.options.collectionOptions(this.instance) : this.options.collectionOptions;\n\n\t\t\tcollection = new this.collectionType(null, options);\n\t\t}\n\n\t\tcollection.model = this.relatedModel;\n\n\t\tif (this.options.collectionKey) {\n\t\t\tlet key = this.options.collectionKey === true ? this.options.reverseRelation.key : this.options.collectionKey;\n\n\t\t\tif (collection[ key ] && collection[ key ] !== this.instance) {\n\t\t\t\tif (config.showWarnings && typeof console !== 'undefined') {\n\t\t\t\t\tconsole.warn('Relation=%o; collectionKey=%s already exists on collection=%o', this, key, this.options.collectionKey);\n\t\t\t\t}\n\t\t\t} else if (key) {\n\t\t\t\tcollection[ key ] = this.instance;\n\t\t\t}\n\t\t}\n\n\t\tthis.listenTo(collection, 'relational:add', this.handleAddition)\n\t\t\t.listenTo(collection, 'relational:remove', this.handleRemoval)\n\t\t\t.listenTo(collection, 'relational:reset', this.handleReset);\n\n\t\treturn collection;\n\t},\n\n\t/**\n\t * Find related Models.\n\t * @param {Object} [options]\n\t * @return {Collection}\n\t */\n\tfindRelated(options) {\n\t\tlet related = null;\n\n\t\toptions = _.defaults({ parse: this.options.parse }, options);\n\n\t\t// Replace 'this.related' by 'this.keyContents' if it is a Collection\n\t\t// Otherwise, 'this.keyContents' should be an array of related object ids.\n\t\t// Re-use the current 'this.related' if it is a Collection; otherwise, create a new collection.\n\t\tif (this.keyContents instanceof Collection) {\n\t\t\tthis._prepareCollection(this.keyContents);\n\t\t\trelated = this.keyContents;\n\t\t} else {\n\t\t\tlet toAdd = [];\n\n\t\t\t_.each(this.keyContents, (attributes) => {\n\t\t\t\tlet model = null;\n\n\t\t\t\tif (attributes instanceof this.relatedModel) {\n\t\t\t\t\tmodel = attributes;\n\t\t\t\t} else {\n\t\t\t\t\t// If `merge` is true, update models here, instead of during update.\n\t\t\t\t\tmodel = (_.isObject(attributes) && options.parse && this.relatedModel.prototype.parse) ?\n\t\t\t\t\t\tthis.relatedModel.prototype.parse(_.clone(attributes), options) : attributes;\n\t\t\t\t}\n\n\t\t\t\tmodel && toAdd.push(model);\n\t\t\t});\n\n\t\t\tif (this.related instanceof Collection) {\n\t\t\t\trelated = this.related;\n\t\t\t} else {\n\t\t\t\trelated = this._prepareCollection();\n\t\t\t}\n\n\t\t\t// By now, `parse` will already have been executed just above for models if specified.\n\t\t\t// Disable to prevent additional calls.\n\t\t\trelated.set(toAdd, _.defaults({ parse: false }, options));\n\t\t}\n\n\t\t// Remove entries from `keyIds` that were already part of the relation (and are thus 'unchanged')\n\t\tthis.keyIds = _.difference(this.keyIds, _.pluck(related.models, 'id'));\n\n\t\treturn related;\n\t},\n\n\t/**\n\t * Normalize and reduce `keyContents` to a list of `ids`, for easier comparison\n\t * @param {String|Number|String[]|Number[]|Collection} keyContents\n\t */\n\tsetKeyContents(keyContents) {\n\t\tthis.keyContents = keyContents instanceof Collection ? keyContents : null;\n\t\tthis.keyIds = [];\n\n\t\tif (!this.keyContents && (keyContents || keyContents === 0)) { // since 0 can be a valid `id` as well\n\t\t\t// Handle cases the an API/user supplies just an Object/id instead of an Array\n\t\t\tthis.keyContents = _.isArray(keyContents) ? keyContents : [keyContents];\n\n\t\t\t_.each(this.keyContents, (item) => {\n\t\t\t\tlet itemId = store.resolveIdForItem(this.relatedModel, item);\n\t\t\t\tif (itemId || itemId === 0) {\n\t\t\t\t\tthis.keyIds.push(itemId);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\n\t/**\n\t * Event handler for `change:<key>`.\n\t * If the contents of the key are changed, notify old & new reverse relations and initialize the new relation.\n\t */\n\tonChange(model, attr, options) {\n\t\toptions = options ? _.clone(options) : {};\n\t\tthis.setKeyContents(attr);\n\t\tthis.changed = false;\n\n\t\tlet related = this.findRelated(options);\n\t\tthis.setRelated(related);\n\n\t\tif (!options.silent) {\n\t\t\teventQueue.add(() => {\n\t\t\t\t// The `changed` flag can be set in `handleAddition` or `handleRemoval`\n\t\t\t\tif (this.changed) {\n\t\t\t\t\tthis.instance.trigger('change:' + this.key, this.instance, this.related, options, true);\n\t\t\t\t\tthis.changed = false;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\n\t/**\n\t * When a model is added to a 'HasMany', trigger 'add' on 'this.instance' and notify reverse relations.\n\t * (should be 'HasOne', must set 'this.instance' as their related).\n\t */\n\thandleAddition(model, coll, options) {\n\t\t//console.debug('handleAddition called; args=%o', arguments);\n\t\toptions = options ? _.clone(options) : {};\n\t\tthis.changed = true;\n\n\t\t_.each(this.getReverseRelations(model), (relation) => {\n\t\t\trelation.addRelated(this.instance, options);\n\t\t});\n\n\t\t// Only trigger 'add' once the newly added model is initialized (so, has its relations set up)\n\t\t!options.silent && eventQueue.add(() => {\n\t\t\tthis.instance.trigger('add:' + this.key, model, this.related, options);\n\t\t});\n\t},\n\n\t/**\n\t * When a model is removed from a 'HasMany', trigger 'remove' on 'this.instance' and notify reverse relations.\n\t * (should be 'HasOne', which should be nullified)\n\t */\n\thandleRemoval(model, coll, options) {\n\t\t//console.debug('handleRemoval called; args=%o', arguments);\n\t\toptions = options ? _.clone(options) : {};\n\t\tthis.changed = true;\n\n\t\t_.each(this.getReverseRelations(model), _.bind(function(relation) {\n\t\t\trelation.removeRelated(this.instance, null, options);\n\t\t}, this));\n\n\t\t!options.silent && eventQueue.add(() => {\n\t\t\tthis.instance.trigger('remove:' + this.key, model, this.related, options);\n\t\t});\n\t},\n\n\thandleReset(coll, options) {\n\t\toptions = options ? _.clone(options) : {};\n\t\t!options.silent && eventQueue.add(() => {\n\t\t\tthis.instance.trigger('reset:' + this.key, this.related, options);\n\t\t});\n\t},\n\n\ttryAddRelated(model, coll, options) {\n\t\tlet item = _.contains(this.keyIds, model.id);\n\n\t\tif (item) {\n\t\t\tthis.addRelated(model, options);\n\t\t\tthis.keyIds = _.without(this.keyIds, model.id);\n\t\t}\n\t},\n\n\taddRelated(model, options) {\n\t\t// Allow 'model' to set up its relations before proceeding.\n\t\t// (which can result in a call to 'addRelated' from a relation of 'model')\n\t\tmodel.queue(() => {\n\t\t\tif (this.related && !this.related.get(model)) {\n\t\t\t\tthis.related.add(model, _.defaults({ parse: false }, options));\n\t\t\t}\n\t\t});\n\t},\n\n\tremoveRelated(model, coll, options) {\n\t\tif (this.related.get(model)) {\n\t\t\tthis.related.remove(model, options);\n\t\t}\n\t}\n});\n","import Semaphore from './utils/semaphore';\nimport BlockingQueue from './utils/blocking-queue';\nimport eventQueue from './event-queue';\nimport config from './config';\nimport Collection from './collection';\nimport relationTypeStore from './relation-type-store';\nimport Relation from './relation';\nimport HasOne from './relation.has-one';\nimport HasMany from './relation.has-many';\nimport Store from './utils/store';\nimport store from './store';\nimport Model from './model';\n\nexport { Collection };\nexport { Model };\n\nexport { Semaphore };\nexport { BlockingQueue };\nexport { eventQueue };\n\nexport { Store };\nexport { store };\n\nexport { relationTypeStore };\nexport { Relation };\nexport { HasOne };\nexport { HasMany };\n\nrelationTypeStore.registerType('HasOne', HasOne);\nrelationTypeStore.registerType('HasMany', HasMany);\n\nexport { config };\n"],"names":["_permitsAvailable","_permitsUsed","Error","amount","_","any","some","all","every","contains","includes","pluck","map","BlockingQueue","_queue","extend","prototype","Semaphore","func","isBlocked","push","queue","length","shift","acquire","release","process","isLocked","Model","ExtendableObject","args","initialize","call","Events","BObject","types","name","Type","RelationTypeStore","_collections","_reverseRelations","_orphanRelations","_subModels","_modelScopes","window","model","relation","options","type","isString","relationTypeStore","find","getObjectByName","isObject","relationType","config","showWarnings","console","warn","scope","without","subModelTypes","superModelType","modelType","subModelDef","filter","subModels","subModelTypeName","typeValue","subModelType","_superModel","_subModelTypeValue","_subModelTypeAttribute","subModelTypeAttribute","exists","rel","val","key","_addRelation","retroFitRelation","each","slice","relatedModel","initializeRelation","relations","subModel","RelationType","coll","getCollection","bind","create","BBModel","constructor","rootModel","item","_createCollection","parts","split","reduce","memo","undefined","Collection","isNumber","id","idAttribute","resolveIdForItem","obj","get","modelColl","collection","add","duplicate","register","_onModelEvent","trigger","models","clone","stopListening","invoke","getRelations","reset","remove","unregister","Store","instance","opts","reverseRelation","defaults","store","keySource","keyDestination","isUndefined","isFunction","result","checkPreconditions","isAutoRelation","addReverseRelation","contentKey","setKeyContents","relatedCollection","attributes","_relations","autoFetch","getAsync","listenTo","destroy","tryAddRelated","removeRelated","i","k","m","rm","keys","existing","related","reverseRelations","j","_isReverseRelation","setRelated","_prepareCollection","getReverseRelations","_deferProcessing","processQueue","off","defer","processOrphanRelations","block","unblock","eventName","toArray","arguments","indexOf","eventQueue","changed","hasChanged","_attributeChangeFired","attr","getRelation","_isInitialized","changedAttrs","value","values","refresh","Relation","ids","keyIds","keyId","requests","idsToFetch","getIdsToFetch","createModels","findModel","attrs","findOrCreate","createdModels","setUrl","url","defaultUrl","error","fetch","deferArray","then","$","when","newId","checkId","set","initializeModelHierarchy","initializeRelations","update","updateRelations","json","toJSON","includeInJSON","concat","keyContents","isArray","curJson","wait","superModel","hasOwnProperty","addSubModels","preInitialize","addOrphanRelation","_findSubModelType","inheritRelations","resolvedSubModels","unresolvedSubModels","omit","isNull","setupSuperModel","inheritedRelations","superRel","parsedAttributes","parse","merge","build","protoProps","classProps","child","setup","BBCollection","TargetModel","validationError","singular","newModels","toAdd","_prepareModel","cid","_byId","sort","toRemove","_removeModels","onChange","findRelated","addRelated","__related","oldRelated","silent","collectionType","collectionOptions","collectionKey","handleAddition","handleRemoval","handleReset","difference","itemId","registerType","HasOne","HasMany"],"mappings":"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"}